# CI Failure Analysis - DNS Race Test

**CI Run**: https://github.com/MaurUppi/dae/actions/runs/22063263964/job/63748548361
**Workflow**: `.github/workflows/dns-race.yml`
**Commit**: 8e9111a "fix dns audit findings and add race-test workflow"

---

## Root Cause

The `dns-race.yml` workflow fails because the `control` package has **build dependencies that are not satisfied**:

1. **BPF code generation**: The `control` package depends on auto-generated BPF Go bindings (e.g., `bpfObjects`, `bpfRoutingResult`) that are created by the `make` process via `cilium/ebpf` tools.

2. **Missing build tools**: The workflow lacks:
   - `clang-15` and `llvm-15` (required for BPF compilation)
   - `git submodule update` (for vendored dependencies)
   - `make` execution (to generate BPF Go bindings)

### Error Evidence

From local reproduction with `GOWORK=off go test -race ./control`:

```
# github.com/daeuniverse/dae/control
control/control_plane_core.go:39:19: undefined: bpfObjects
control/dns_control.go:372:17: undefined: bpfRoutingResult
control/routing_matcher_userspace.go:23:12: undefined: bpfMatchSet
...
FAIL	github.com/daeuniverse/dae/control [build failed]
```

These types are generated by `go:generate` directives or Makefile steps that invoke `bpf2go` from `github.com/cilium/ebpf/cmd/bpf2go`.

---

## Comparison with Working Workflows

The `seed-build.yml` (used by `pr-build.yml` and `build.yml`) includes all necessary steps:

```yaml
- name: Install Dependencies
  run: |
    sudo apt-get update -y
    sudo apt-get install -y clang-15 llvm-15

- name: Get project dependencies
  run: |
    git submodule update --init --recursive
    GOMODCACHE="${PWD}"/go-mod go mod download -modcacherw

- name: Build dae
  run: |
    export CLANG=clang-15
    export STRIP=llvm-strip-15
    make
```

The `dns-race.yml` workflow jumps directly to `go test -race` without these prerequisites.

---

## Solution Options

### Option 1: Add full build pipeline (Recommended)

Replicate the build steps from `seed-build.yml`:

```yaml
- name: Install Dependencies
  run: |
    sudo apt-get update -y
    sudo apt-get install -y clang-15 llvm-15

- name: Get project dependencies
  run: |
    git submodule update --init --recursive
    go mod download

- name: Generate BPF code
  run: |
    export CLANG=clang-15
    make APPNAME=dae dae

- name: Run race detector for control package
  run: go test -race -v ./control/...
```

**Pros**:
- Ensures all code generation is done
- Matches production build environment
- Tests run against fully compiled codebase

**Cons**:
- Slower (adds ~1-2 minutes for BPF compilation)
- Requires BPF toolchain

### Option 2: Test only dns_improvement_test.go (Fast path - NOT recommended)

Since `dns_improvement_test.go` has minimal dependencies, we could isolate it:

```yaml
- name: Run race detector for DNS improvement tests
  run: |
    cd control
    go test -race -v -run 'Test(IsTimeoutError|TcpFallbackDialArgument|SendStreamDNSRespectsContextCancelBeforeIO|EvictDnsForwarderCacheOneLocked)' .
```

**Pros**:
- Fast (no BPF compilation)
- Focused on DNS changes

**Cons**:
- Doesn't test integration with the full `control` package
- Misses race conditions in `dialSend` and broader DNS controller lifecycle
- Could mask issues that only appear with real forwarder instantiation

### Option 3: Skip race test for now, document limitation

Add a comment explaining why race test is disabled:

```yaml
# TODO: This test requires BPF code generation which needs clang-15.
# For now, we rely on the main build workflow's compilation checks.
# Re-enable once we have a lightweight test setup.
```

**Pros**:
- Unblocks PR merges
- Documents the limitation

**Cons**:
- Loses race detection coverage
- Defeats the purpose of adding the workflow

---

## Recommendation

**Implement Option 1** â€” Full build pipeline.

Race detection is critical for catching the P0-1 issue (DoUDP goroutine race) and similar concurrency bugs. The ~1-2 minute overhead is justified for:

1. **Safety**: Race detector catches data races that can cause production crashes
2. **Completeness**: Tests run against the actual integrated codebase
3. **Consistency**: Mirrors the production build environment

The workflow should trigger sparingly (only on `control/**/*.go` changes), so the overhead impact is minimal.

---

## Implementation

See updated `.github/workflows/dns-race.yml` below:

```yaml
name: DNS Race Test

on:
  pull_request:
    paths:
      - "control/**/*.go"
      - "go.mod"
      - "go.sum"
      - ".github/workflows/dns-race.yml"
  push:
    branches:
      - main
    paths:
      - "control/**/*.go"
      - "go.mod"
      - "go.sum"
      - ".github/workflows/dns-race.yml"

jobs:
  race-test:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '^1.22'
          cache-dependency-path: |
            go.mod
            go.sum

      - name: Install BPF build dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y clang-15 llvm-15

      - name: Download Go modules
        run: go mod download

      - name: Generate BPF code
        run: |
          export CLANG=clang-15
          make APPNAME=dae dae

      - name: Run race detector for control package
        run: go test -race -v ./control/...
```

---

## Verification Steps

After applying the fix:

1. Push to branch and trigger CI
2. Verify BPF code generation succeeds
3. Verify tests compile and run
4. Check for any race warnings in output
5. Confirm total CI time is acceptable (<5 min)

---

## Follow-up Actions

1. **Monitor CI duration**: If race tests become a bottleneck, consider splitting into separate workflow that runs less frequently (e.g., daily or on-demand)

2. **Add caching**: Cache BPF build artifacts to speed up subsequent runs:
   ```yaml
   - uses: actions/cache@v4
     with:
       path: control/kern/
       key: bpf-${{ hashFiles('control/kern/**/*.c', 'control/kern/**/*.h') }}
   ```

3. **Expand coverage**: Once stable, extend to other packages with concurrency:
   ```bash
   go test -race ./component/...
   ```
