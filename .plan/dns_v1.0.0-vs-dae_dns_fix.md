# dae-v1.0.0 vs dae-dns-fix — DNS 性能对比报告

**测试时间**：2026-02-17
**测试命令**：`python3 main.py endurance --job dns --sample-size 200 --duration 2m --source targets/geosite_geolocation-cn.txt --dns-server 192.168.1.15`
**数据文件**：

| 版本 | 第1次 | 第2次 |
|---|---|---|
| dae-v1.0.0 | `data/probes_20260217_165341.csv` | `data/probes_20260217_165626.csv` |
| dae-dns-fix | `data/probes_20260217_170459.csv` | `data/probes_20260217_170709.csv` |

各版本 ×2 次 ×4 轮 × 200 域名 = **1600 条查询**，随机从 `geosite_geolocation-cn.txt` 抽样。

---

## §1  数据集规模与域名分布

| | v1.0.0 (×2次) | dns-fix (×2次) |
|---|---|---|
| 总查询条数 | 1600 | 1600 |
| 唯一域名数 | 1370 | 1373 |
| 两版本共同域名 | 472 (20.8%) | — |
| 仅本版本独有 | 898 | 901 |

### 缓存污染说明

两次测试间隔约 **11 分钟**，存在两类缓存干扰：

| 来源 | 影响范围 | 严重程度 |
|---|---|---|
| 跨版本缓存（v1→fix 同一域名，部分 TTL 未过期） | 共同域名 472 个；dns-fix 中 62.7% 命中缓存 vs v1 的 27.3% | ⚠️ 严重，全量 median 数据失真 |
| DNS 服务器 `192.168.1.15` 自身缓存（热门域名被其他客户端预热） | 独有域名首轮仍有 ~26-30% 响应 < 2ms | ℹ️ 中等，client 侧无法消除 |

> **结论**：全量数据的 median/mean 改善幅度因缓存污染被高估，**延迟对比以「严格冷查询」（独有域名 × 首轮）为准**。

---

## §2  成功率 & 响应结果类型

基于首次出现去重统计：

| 类型 | v1.0.0 | dns-fix |
|---|---|---|
| **成功率** | **100%** (1370/1370) | **100%** (1373/1373) |
| 直接 A 记录 | 702 (51.2%) | 678 (49.4%) |
| CNAME 链 | 239 (17.4%) | 256 (18.6%) |
| NOERROR:no-A-record | 429 (31.3%) | 439 (32.0%) |
| 失败 | **0** | **0** |

两版本均零失败，答案类型分布一致，差异属随机抽样正常波动。

> **关于 NOERROR:no-A-record**：约 31% 的域名 DNS 服务器返回 `NOERROR + ANSWER:0`，表示域名存在但无 A 记录（可能仅有 MX/AAAA/TXT 记录）。这是合法的 DNS 响应，属正常现象，与版本无关。

---

## §3  延迟对比

### 3a. 全量合并（含缓存污染，仅供参考）

| 指标 | v1.0.0 | dns-fix | 变化 |
|---|---|---|---|
| median | 21.0 ms | 2.0 ms | -90.5% ⚠️ 失真 |
| mean | 71.6 ms | 53.8 ms | -24.9% ⚠️ 失真 |
| p95 | 203.0 ms | 100.0 ms | -50.7% |
| p99 | 1674.0 ms | 1495.0 ms | -10.7% |
| max | 3028.0 ms | 3010.0 ms | ≈ 持平 |

⚠️ median/mean 改善因跨版本缓存命中率差异（27% vs 63%）被严重高估。

### 3b. 严格冷查询（独有域名 × 首轮，最小化缓存影响）

样本：v1.0.0 n=118，dns-fix n=144；仍有 ~26-30% `<2ms` 为服务器端缓存，无法在 client 侧消除。

| 指标 | v1.0.0 | dns-fix | 变化 |
|---|---|---|---|
| **全量 median** | 23.0 ms | 23.5 ms | +2.2%（**无显著差异**）|
| **全量 p95** | 181.0 ms | **100.0 ms** | **-44.8% ✅** |
| 全量 mean | 81.6 ms | 65.4 ms | -19.9% |
| 全量 p99 | 1797.0 ms | 1640.0 ms | -8.7% |
| 全量 max | 3010.0 ms | 3008.0 ms | ≈ 持平 |
| **去缓存(≥2ms) median** | 40.0 ms | 44.0 ms | +10.0%（**无显著差异**）|
| **去缓存(≥2ms) p95** | 209.0 ms | **106.0 ms** | **-49.3% ✅** |

---

## §4  延迟分布（冷查询累积百分比）

| 区间 | v1.0.0 | dns-fix | 变化 |
|---|---|---|---|
| ≤ 2ms（疑似缓存） | 28.8% | 31.9% | +10.9% |
| ≤ 10ms | 37.3% | 35.4% | -5.0%（持平）|
| ≤ 50ms | 75.4% | 75.7% | +0.4%（持平）|
| ≤ 100ms | 92.4% | **95.1%** | +3.0% ✅ |
| ≤ 200ms | 95.8% | **97.9%** | +2.2% ✅ |
| ≤ 500ms | 97.5% | **98.6%** | +1.2% ✅ |
| **> 1000ms（慢查询）** | **1.7%** (2条) | **1.4%** (2条) | **-18.1% ✅** |

100ms 以上的长尾查询，dns-fix 各档均有改善。

---

## §5  轮次稳定性

各轮 median 延迟趋势（单位 ms）及缓存命中率（`<2ms` 占比）：

```
v1.0.0 第1次:  24 → 48 → 23 → 21 ms   <2ms: 25% → 25% → 31% → 34%
v1.0.0 第2次:  21 → 21 → 20 →  6 ms   <2ms: 33% → 31% → 35% → 43%
dns-fix 第1次: 19 →  2 →  8 →  2 ms   <2ms: 36% → 47% → 45% → 50%
dns-fix 第2次:  1 →  1 →  1 →  1 ms   <2ms: 53% → 54% → 53% → 57%
```

各轮 p95 延迟：

| 版本 | 轮1 | 轮2 | 轮3 | 轮4 |
|---|---|---|---|---|
| v1.0.0 第1次 | 209ms | 235ms | 228ms | 209ms |
| v1.0.0 第2次 | 125ms | 120ms | 272ms | 215ms |
| dns-fix 第1次 | 106ms | 95ms | 111ms | 91ms |
| dns-fix 第2次 | 118ms | 85ms | 83ms | 134ms |

**观察**：
- v1.0.0 轮次间 median 波动明显（最大 24→48ms），无收敛趋势
- dns-fix 第1次第2轮起 median 迅速收敛至 2ms；第2次全程稳定在 1ms
- dns-fix 的 p95 各轮稳定在 83 ~ 134ms，v1.0.0 则在 120 ~ 272ms 之间波动
- **dns-fix 对 DNS 服务器的缓存预热效率显著更高，缓存命中率随轮次持续提升**

---

## §6  错误分析

两版本 **失败数均为 0**，无任何超时、SERVFAIL、NXDOMAIN 或连接错误。

---

## §7  综合结论

| 维度 | v1.0.0 | dns-fix | 结论 |
|---|---|---|---|
| **成功率** | 100% | 100% | 持平 |
| **中位延迟（冷查询）** | ~23ms | ~24ms | **无显著差异** |
| **p95 长尾延迟（冷查询）** | 181ms | **100ms** | **dns-fix 改善 -45%~-49% ✅** |
| **慢查询 >1s** | 1.7% | **1.4%** | dns-fix 略优（-18%）✅ |
| **max 延迟** | 3028ms | 3010ms | 持平（dig `+tries=3` 超时上限，与版本无关）|
| **轮次稳定性** | 波动较大，不收敛 | **迅速收敛，全程稳定** | **dns-fix 更稳定 ✅** |
| **缓存预热效率** | 末轮才开始下降 | **第2轮即收敛** | **dns-fix 缓存利用率更高 ✅** |
| **答案质量** | 一致（31% no-A-record）| 一致 | 持平 |

### 核心结论

> **dns-fix 在中位延迟上与 v1.0.0 无显著差异，但 p95 长尾延迟改善约 45%，轮次稳定性和缓存预热效率明显更优。** 这说明 dns-fix 主要解决了高百分位的抖动问题，对于普通查询（缓存命中或低延迟链路）无负面影响。

### 后续建议

若要消除 DNS 服务器自身缓存的干扰（当前约 27-30% 冷查询仍疑似命中服务器缓存），建议在每次测试前执行：

```bash
# 在 192.168.1.15 上清空 DNS 缓存（以 Unbound 为例）
unbound-control flush_zone .
# 或 BIND
rndc flush
```

以获得更纯粹的冷查询对比数据。
